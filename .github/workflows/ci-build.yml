name: ci-build
on:
  push:
    branches: [ main ]
    paths: [ "app/**", ".github/workflows/ci-build.yml" ]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 20

    - id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
        service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}

    - uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker auth to Artifact Registry
      run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev

    - name: Build & push images
      run: |
        REPO="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT }}/apps"
        docker build -t "$REPO/api:${{ github.sha }}" app/api
        docker build -t "$REPO/web:${{ github.sha }}" app/web
        docker push "$REPO/api:${{ github.sha }}"
        docker push "$REPO/web:${{ github.sha }}"
    - name: Set image tag env
      run: echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
